<!DOCTYPE html>
<html>
<head>
    <title>Realtime Emotion Dashboard</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- <h1>Realtime Emotion Dashboard</h1>
    <div id="dashboard"></div> -->
    <h1>Realtime Emotion Dashboard</h1>
    <style>
        h1{
            background-color: aquamarine;
            padding-top: 0;
        }
    </style>
    <div>
        <video id="video" width="1020" height="540" autoplay muted></video>
        <canvas id="overlay" width="320" height="240" style="position:absolute; left:0; top:0;"></canvas>
        <div id="emotion-result"></div>
    </div>
    <div id="dashboard"></div>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
    <script>
        // Start webcam
        const video = document.getElementById('video');
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => { video.srcObject = stream; });

        // Load models and detect emotions
        Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri('/models'),
            faceapi.nets.faceExpressionNet.loadFromUri('/models')
        ]).then(startEmotionDetection);

        function startEmotionDetection() {
            video.addEventListener('play', () => {
                const canvas = document.getElementById('overlay');
                const displaySize = { width: video.width, height: video.height };
                faceapi.matchDimensions(canvas, displaySize);
                setInterval(async () => {
                    const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
                    const resizedDetections = faceapi.resizeResults(detections, displaySize);
                    canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                    faceapi.draw.drawDetections(canvas, resizedDetections);
                    if (detections.length > 0) {
                        const emotions = detections[0].expressions;
                        const maxEmotion = Object.keys(emotions).reduce((a, b) => emotions[a] > emotions[b] ? a : b);
                        document.getElementById('emotion-result').innerText = `Detected Emotion: ${maxEmotion}`;
                    } else {
                        document.getElementById('emotion-result').innerText = 'No face detected';
                    }
                }, 1000);
            });
        }

        function fetchEmotions() {
            fetch("/api/emotions/")
                .then(response => response.json())
                .then(data => {
                    const dashboard = document.getElementById('dashboard');
                    dashboard.innerHTML = '';
                    data.forEach(item => {
                        const div = document.createElement('div');
                        div.innerHTML = `<strong>Time:</strong> ${item.time} â€” <strong>Emotion:</strong> ${item.emotion}`;
                        dashboard.appendChild(div);
                    });
                });
        }

        setInterval(fetchEmotions, 2000);  // Poll every 2 seconds
        fetchEmotions();
    </script>
</body>
</html>
